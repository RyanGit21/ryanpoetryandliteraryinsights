<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DYGKTNNN1P"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DYGKTNNN1P');
</script>

<title>Loading... - Ryan's Poetic and Literary Insights</title>

<meta name="description" content="Read this post from Ryan's collection of poetry and literary insights.">
<meta name="keywords" content="poetry, literature, creative writing, Ryan's blog">
<meta name="author" content="Ryan">
<meta name="robots" content="index, follow">

<meta property="og:title" content="Ryan's Poetic and Literary Insights" id="og-title">
<meta property="og:description" content="A post from Ryan's literary collection" id="og-description">
<meta property="og:type" content="article">
<meta property="og:url" content="" id="og-url">

<link rel="preconnect" href="https://zqmgtnnwrceagkshfapq.supabase.co">
<link rel="dns-prefetch" href="https://zqmgtnnwrceagkshfapq.supabase.co">

<script type="application/ld+json" id="schema-data">
{"@context":"https://schema.org","@type":"BlogPosting","headline":"","author":{"@type":"Person","name":"Ryan"},"datePublished":"","description":""}
</script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Georgia',serif;background:linear-gradient(135deg,#667eea,#764ba2);color:#333;line-height:1.8;min-height:100vh}
.container{max-width:900px;margin:0 auto;padding:20px}
header{text-align:center;padding:40px 20px}
header a{color:white;text-decoration:none;font-size:1.2em;display:inline-flex;align-items:center;gap:10px;background:rgba(255,255,255,0.2);padding:10px 20px;border-radius:25px;transition:all 0.3s ease}
header a:hover{background:rgba(255,255,255,0.3);transform:translateY(-2px)}
article{background:white;border-radius:20px;padding:50px;margin:30px 0;box-shadow:0 15px 50px rgba(0,0,0,0.3)}
article.poem{background:linear-gradient(135deg,#ffecd2,#fcb69f);border-left:5px solid #ff6b6b}
article.article{border-left:5px solid #667eea}
.article-title{font-size:3em;color:#667eea;margin-bottom:15px;line-height:1.2}
.article-meta{display:flex;gap:20px;color:#999;margin-bottom:30px;flex-wrap:wrap}
.article-type-badge{background:#667eea;color:white;padding:5px 15px;border-radius:20px;font-size:0.9em;text-transform:capitalize}
article.poem .article-type-badge{background:#ff6b6b}
.article-content{font-size:1.2em;line-height:2;color:#444}
.article-content p{margin-bottom:1.5em}
.article-content p:last-child{margin-bottom:0}
article.poem .article-content{white-space:pre-wrap;font-style:italic}
.loading-container{text-align:center;padding:100px 20px;color:white}
.spinner{border:4px solid rgba(255,255,255,0.3);border-top:4px solid white;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;margin:0 auto 20px}
@keyframes spin{to{transform:rotate(360deg)}}
.error-container{text-align:center;padding:100px 20px;color:white}
.error-container h2{font-size:2em;margin-bottom:20px}
.error-container p{font-size:1.2em;opacity:0.9;margin-bottom:30px}
.error-container a{color:white;background:rgba(255,255,255,0.2);padding:12px 30px;border-radius:25px;text-decoration:none;display:inline-block;transition:all 0.3s ease}
.error-container a:hover{background:rgba(255,255,255,0.3);transform:translateY(-2px)}

.post-navigation{display:flex;justify-content:space-between;align-items:center;gap:20px;margin:40px 0;padding:30px;background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.2)}
.nav-link{flex:1;text-decoration:none;color:#333;padding:20px;border-radius:10px;transition:all 0.3s ease;background:rgba(102,126,234,0.05);display:block}
.nav-link:hover{background:rgba(102,126,234,0.1);transform:translateX(5px)}
.nav-link.prev:hover{transform:translateX(-5px)}
.nav-link-label{font-size:0.85em;color:#999;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;display:block}
.nav-link-title{font-size:1.1em;color:#667eea;font-weight:bold;display:block}
.nav-link.disabled{opacity:0.3;pointer-events:none;cursor:default}
.nav-divider{width:2px;height:60px;background:linear-gradient(180deg,rgba(102,126,234,0.1),rgba(102,126,234,0.3),rgba(102,126,234,0.1))}

@media(max-width:768px){
    article{padding:30px 20px}
    .article-title{font-size:2em}
    .article-content{font-size:1.1em}
    .post-navigation{flex-direction:column;padding:20px}
    .nav-divider{width:100%;height:2px;background:linear-gradient(90deg,rgba(102,126,234,0.1),rgba(102,126,234,0.3),rgba(102,126,234,0.1))}
    .nav-link{width:100%;text-align:center}
}
</style>
</head>

<body>
<div class="container">
<header>
<a href="index.html">← Back to All Posts</a>
</header>

<main id="main-content">
<div class="loading-container">
<div class="spinner"></div>
<p>Loading post...</p>
</div>
</main>

<div id="nav-container"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" async></script>
<script>
const SUPABASE_URL="https://zqmgtnnwrceagkshfapq.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxbWd0bm53cmNlYWdrc2hmYXBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MDI2ODgsImV4cCI6MjA4MjI3ODY4OH0.Ql5KP6nfOSRzz1Z2eyN6WTqDsfVwZ0e9GKIbePa9eZE";

let sb;
const params=new URLSearchParams(window.location.search);
const postId=params.get("id");

const CACHE_PREFIX='post_';
const CACHE_DURATION=30*60*1000;
const ALL_POSTS_CACHE='blog_posts_cache_v2';

function getCachedPost(id){
    try{
        const cached=localStorage.getItem(CACHE_PREFIX+id);
        if(!cached)return null;
        const{data,timestamp}=JSON.parse(cached);
        if(Date.now()-timestamp<CACHE_DURATION)return data;
        localStorage.removeItem(CACHE_PREFIX+id);
        return null;
    }catch(e){return null}
}

function setCachedPost(id,post){
    try{
        localStorage.setItem(CACHE_PREFIX+id,JSON.stringify({data:post,timestamp:Date.now()}));
    }catch(e){}
}

function getAllCachedPosts(){
    try{
        const cached=localStorage.getItem(ALL_POSTS_CACHE);
        if(!cached)return null;
        const{data,timestamp}=JSON.parse(cached);
        if(Date.now()-timestamp<CACHE_DURATION)return data;
        return null;
    }catch(e){return null}
}

function escapeHtml(text){
    const div=document.createElement("div");
    div.textContent=text;
    return div.innerHTML;
}

function formatDate(date){
    return new Date(date).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});
}

function updateMetadata(post){
    document.title=`${post.title} - Ryan's Poetic and Literary Insights`;
    
    const description=post.content.substring(0,155)+(post.content.length>155?'...':'');
    document.querySelector('meta[name="description"]').setAttribute('content',description);
    
    document.getElementById('og-title').setAttribute('content',post.title);
    document.getElementById('og-description').setAttribute('content',description);
    document.getElementById('og-url').setAttribute('content',window.location.href);
    
    const schemaData={
        "@context":"https://schema.org",
        "@type":"BlogPosting",
        "headline":post.title,
        "author":{"@type":"Person","name":"Ryan"},
        "datePublished":post.created_at,
        "description":description
    };
    document.getElementById('schema-data').textContent=JSON.stringify(schemaData);
}

function renderPost(data){
    updateMetadata(data);

    const content=data.type==="poem"
        ?escapeHtml(data.content)
        :data.content.split("\n\n").map(p=>`<p>${escapeHtml(p)}</p>`).join("");

    document.getElementById("main-content").innerHTML=`
        <article class="${escapeHtml(data.type)}">
            <h1 class="article-title">${escapeHtml(data.title)}</h1>
            <div class="article-meta">
                <span class="article-type-badge">${escapeHtml(data.type)}</span>
                <time datetime="${data.created_at}">${formatDate(data.created_at)}</time>
            </div>
            <div class="article-content">${content}</div>
        </article>
    `;
}

async function renderNavigation(currentPostId){
    try{
        let allPosts=getAllCachedPosts();
        
        if(!allPosts){
            const{data,error}=await sb.from('posts').select('id,title,created_at').order('created_at',{ascending:false});
            if(error)throw error;
            allPosts=data||[];
        }
        
        const currentIndex=allPosts.findIndex(p=>p.id==currentPostId);
        if(currentIndex===-1)return;
        
        const prevPost=currentIndex<allPosts.length-1?allPosts[currentIndex+1]:null;
        const nextPost=currentIndex>0?allPosts[currentIndex-1]:null;
        
        const navHTML=`
            <nav class="post-navigation" aria-label="Post navigation">
                ${prevPost?`
                    <a href="post.html?id=${prevPost.id}" class="nav-link prev" onmouseenter="prefetchPost(${prevPost.id})">
                        <span class="nav-link-label">← Previous</span>
                        <span class="nav-link-title">${escapeHtml(prevPost.title)}</span>
                    </a>
                `:`
                    <div class="nav-link disabled">
                        <span class="nav-link-label">← Previous</span>
                        <span class="nav-link-title">No older posts</span>
                    </div>
                `}
                
                <div class="nav-divider"></div>
                
                ${nextPost?`
                    <a href="post.html?id=${nextPost.id}" class="nav-link next" onmouseenter="prefetchPost(${nextPost.id})">
                        <span class="nav-link-label">Next →</span>
                        <span class="nav-link-title">${escapeHtml(nextPost.title)}</span>
                    </a>
                `:`
                    <div class="nav-link disabled">
                        <span class="nav-link-label">Next →</span>
                        <span class="nav-link-title">No newer posts</span>
                    </div>
                `}
            </nav>
        `;
        
        document.getElementById('nav-container').innerHTML=navHTML;
    }catch(err){
        console.error('Error rendering navigation:',err);
    }
}

function prefetchPost(id){
    if(getCachedPost(id))return;
    
    sb.from("posts").select("*").eq("id",id).single().then(({data})=>{
        if(data)setCachedPost(id,data);
    }).catch(()=>{});
}

function showError(title,message){
    document.getElementById("main-content").innerHTML=`
        <div class="error-container">
            <h2>${title}</h2>
            <p>${message}</p>
            <a href="index.html">Return to Homepage</a>
        </div>
    `;
    document.title=`${title} - Ryan's Poetic and Literary Insights`;
}

async function loadPost(){
    if(!postId){
        showError("Post Not Found","The post you're looking for doesn't exist or the link is incorrect.");
        return;
    }

    const cachedPost=getCachedPost(postId);
    if(cachedPost){
        renderPost(cachedPost);
        renderNavigation(postId);
        fetchPostInBackground();
        return;
    }

    try{
        const{data,error}=await Promise.race([
            sb.from("posts").select("*").eq("id",postId).single(),
            new Promise((_,reject)=>setTimeout(()=>reject(new Error('Timeout')),8000))
        ]);

        if(error||!data)throw new Error('Post not found');

        setCachedPost(postId,data);
        renderPost(data);
        renderNavigation(postId);
    }catch(err){
        console.error('Error loading post:',err);
        
        try{
            const expiredCache=localStorage.getItem(CACHE_PREFIX+postId);
            if(expiredCache){
                const{data}=JSON.parse(expiredCache);
                renderPost(data);
                renderNavigation(postId);
                const warning=document.createElement('div');
                warning.style.cssText='position:fixed;top:10px;right:10px;background:rgba(255,193,7,0.9);color:#333;padding:10px 20px;border-radius:8px;font-size:0.9em;z-index:1000;box-shadow:0 5px 15px rgba(0,0,0,0.2);';
                warning.textContent='Offline mode - showing cached version';
                document.body.appendChild(warning);
                setTimeout(()=>warning.remove(),3000);
                return;
            }
        }catch(e){}
        
        showError("Oops! Something went wrong","We couldn't load this post. Please check your connection and try again.");
    }
}

async function fetchPostInBackground(){
    try{
        const{data,error}=await sb.from("posts").select("*").eq("id",postId).single();
        if(!error&&data){
            setCachedPost(postId,data);
        }
    }catch(e){}
}

function initSupabase(){
    if(window.supabase){
        sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
        loadPost();
    }else{
        setTimeout(initSupabase,100);
    }
}

document.addEventListener('keydown',function(e){
    if(e.key==='ArrowLeft'){
        const prevLink=document.querySelector('.nav-link.prev:not(.disabled)');
        if(prevLink&&prevLink.href)window.location.href=prevLink.href;
    }else if(e.key==='ArrowRight'){
        const nextLink=document.querySelector('.nav-link.next:not(.disabled)');
        if(nextLink&&nextLink.href)window.location.href=nextLink.href;
    }
});

initSupabase();
</script>
</body>
</html>